# -*- coding: utf-8 -*-
"""Data_Fetcher.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/18j077YVgJDy3b9zunMBxn1zxFB9qWiXv
"""

from google.colab import drive
from google.colab import userdata
import os

"""Mounting Drive so that I can access the folder structure"""

drive.mount('/content/drive')

"""Defining my file paths to access them"""

BASE_PATH = '/content/drive/MyDrive/Satellite_Property_Project'
RAW_DATA_PATH = os.path.join(BASE_PATH, 'data/raw')
TRAIN_IMG_PATH = os.path.join(BASE_PATH, 'data/images_train')
TEST_IMG_PATH = os.path.join(BASE_PATH, 'data/images_test')

print("Checking for data...")
if os.path.exists(RAW_DATA_PATH):
    print(f"Found folder: {RAW_DATA_PATH}")
    print("Files:", os.listdir(RAW_DATA_PATH))
else:
    print(f"ERROR: Folder not found at {RAW_DATA_PATH}. Please check Step 1.")

API_SERVICE = 'mapbox'
API_KEY = userdata.get("API_KEY")

if not API_KEY:
    raise ValueError("API_KEY not found")

"""I have used the mapbox api to import images and I have defined the zoom level as 18 and defined the pixel size as 600 X 600 pixels.
To make sure I dont get blocked by them I introduced a time sleep of 0.03
"""

import pandas as pd
import requests
import os
from tqdm import tqdm
import time

URL_TEMPLATE = "https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/{lon},{lat},18,0/600x600?access_token={key}"

def download_images(df, save_folder, limit=None):

    success_count = 0
    error_count = 0

    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
        print(f"Created folder: {save_folder}")

    loop_limit = limit if limit else len(df)

    print(f"Starting download for {loop_limit} properties...")

    for index, row in tqdm(df.head(loop_limit).iterrows(), total=loop_limit):
        try:
            prop_id = str(row['id'])
            lat = row['lat']
            lon = row['long']

            file_path = os.path.join(save_folder, f"{prop_id}.jpg")
            if os.path.exists(file_path):
                continue

            if API_SERVICE == 'mapbox':
                url = URL_TEMPLATE.format(lat=lat, lon=lon, key=API_KEY)
            else:
                url = URL_TEMPLATE.format(lat=lat, lon=lon, key=API_KEY)

            response = requests.get(url, stream=True)

            if response.status_code == 200:
                with open(file_path, 'wb') as f:
                    for chunk in response.iter_content(1024):
                        f.write(chunk)
                success_count += 1
            else:
                print(f"Failed ID {prop_id}: Status {response.status_code}")
                error_count += 1

        except Exception as e:
            print(f"Error on ID {prop_id}: {e}")
            error_count += 1

        time.sleep(0.03)

    print(f"\nDownload Complete.")
    print(f"Success: {success_count}")
    print(f"Errors: {error_count}")


train_df = pd.read_excel(os.path.join(RAW_DATA_PATH, 'train(1).xlsx'))
test_df = pd.read_excel(os.path.join(RAW_DATA_PATH, 'test2.xlsx'))

print(f"Loaded Train: {train_df.shape}, Test: {test_df.shape}")

print("\n--- RUNNING TEST BATCH (5 Images) ---")
download_images(train_df, TRAIN_IMG_PATH, limit=5)

print("\n--- RUNNING FULL TRAIN DOWNLOAD ---")
download_images(train_df, TRAIN_IMG_PATH, limit=None)

print("\n--- RUNNING FULL TEST DOWNLOAD ---")
download_images(test_df, TEST_IMG_PATH, limit=None)